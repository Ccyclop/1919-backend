pipeline {
    agent {
        docker {
            image 'alpine/socat:latest'
            args '--privileged' // Required to enable Docker-in-Docker
        }
    }
    stages {
        stage('Setup Docker') {
            steps {
                script {
                    // Install Docker CLI in the agent if needed
                    sh '''
                    apk add --no-cache docker-cli
                    '''
                }
            }
        }
        stage('Build') {
            steps {
                echo "Building.."
                // Pull and use the node image to build the project
                sh '''
                docker pull node:22-bullseye
                docker run --rm -v "$PWD":/usr/src/app -w /usr/src/app node:22-bullseye sh -c "
                    npm install && npm run build
                "
                '''
            }
        }
        stage('Test') {
            steps {
                echo "Testing.."
                // Use the same node image to run tests
                sh '''
                docker run --rm -v "$PWD":/usr/src/app -w /usr/src/app node:22-bullseye sh -c "
                    npm run test
                "
                '''
            }
        }
        stage('Deliver') {
            steps {
                echo 'Delivering...'
                // Build the final Docker image for delivery
                sh '''
                docker build -t my-app-image:latest .
                docker tag my-app-image:latest your-registry/my-app-image:latest
                docker push your-registry/my-app-image:latest
                '''
            }
        }
    }
}
